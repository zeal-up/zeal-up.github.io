<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zeal-up.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.15.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="⭐ Zeal&#39;s Blog 🛠 Zeal&#39;s 知乎专栏 🌀 Zeal&#39;s Github  本文内容 本文的主要目的在于介绍自动驾驶中环视投影，也就是所谓的俯瞰图&#x2F;鸟瞰图&#x2F;BEV图，其背后的计算机视觉原理。环视投影的背后理论基础就是单应矩阵（Homography Matrix）。为了建立从直观到一般形式，本文从以下章节内容展开 在第一节中先规定相机坐标系和图像坐标系，以及介绍常用的车辆坐标系的">
<meta property="og:type" content="article">
<meta property="og:title" content="超详细！从单应矩阵推导到自动驾驶环视投影应用">
<meta property="og:url" content="https://zeal-up.github.io/2023/06/08/cv/surround-view-projection/index.html">
<meta property="og:site_name" content="Zeal&#39;s Blog">
<meta property="og:description" content="⭐ Zeal&#39;s Blog 🛠 Zeal&#39;s 知乎专栏 🌀 Zeal&#39;s Github  本文内容 本文的主要目的在于介绍自动驾驶中环视投影，也就是所谓的俯瞰图&#x2F;鸟瞰图&#x2F;BEV图，其背后的计算机视觉原理。环视投影的背后理论基础就是单应矩阵（Homography Matrix）。为了建立从直观到一般形式，本文从以下章节内容展开 在第一节中先规定相机坐标系和图像坐标系，以及介绍常用的车辆坐标系的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zeal-up.github.io/2023/06/08/cv/surround-view-projection/imgs/01-pinhole.png">
<meta property="og:image" content="https://zeal-up.github.io/2023/06/08/cv/surround-view-projection/imgs/02-vehical_coordinate.png">
<meta property="og:image" content="https://zeal-up.github.io/2023/06/08/cv/surround-view-projection/imgs/03-multi_camera.png">
<meta property="og:image" content="https://zeal-up.github.io/2023/06/08/cv/surround-view-projection/imgs/04-homo_general.png">
<meta property="og:image" content="https://zeal-up.github.io/2023/06/08/cv/surround-view-projection/imgs/05-ground_coor.png">
<meta property="og:image" content="https://zeal-up.github.io/2023/06/08/cv/surround-view-projection/imgs/06-perspective_correction.png">
<meta property="og:image" content="https://zeal-up.github.io/2023/06/08/cv/surround-view-projection/imgs/07-compute-homo.png">
<meta property="article:published_time" content="2023-06-08T01:38:44.000Z">
<meta property="article:modified_time" content="2023-06-14T04:07:02.247Z">
<meta property="article:author" content="Zeal">
<meta property="article:tag" content="camera projection">
<meta property="article:tag" content="视觉基础">
<meta property="article:tag" content="环视投影">
<meta property="article:tag" content="单应矩阵">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zeal-up.github.io/2023/06/08/cv/surround-view-projection/imgs/01-pinhole.png">


<link rel="canonical" href="https://zeal-up.github.io/2023/06/08/cv/surround-view-projection/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://zeal-up.github.io/2023/06/08/cv/surround-view-projection/","path":"2023/06/08/cv/surround-view-projection/","title":"超详细！从单应矩阵推导到自动驾驶环视投影应用"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>超详细！从单应矩阵推导到自动驾驶环视投影应用 | Zeal's Blog</title>
  
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-SE75EDBKX6","only_pageview":true}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?41fc030db57d5570dd22f78997dc4a7e"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>
  <a target="_blank" rel="noopener" href="https://github.com/zeal-up" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Zeal's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">好好学习～天天向上～</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E6%96%87%E5%86%85%E5%AE%B9"><span class="nav-number">1.</span> <span class="nav-text">本文内容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E5%8F%8A%E7%9B%B8%E5%85%B3%E5%AE%9A%E4%B9%89"><span class="nav-number">2.</span> <span class="nav-text">基础知识及相关定义</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E6%9C%BA%E5%9D%90%E6%A0%87%E7%B3%BB%E4%B8%8E%E5%9B%BE%E5%83%8F%E5%9D%90%E6%A0%87%E7%B3%BB"><span class="nav-number">2.1.</span> <span class="nav-text">相机坐标系与图像坐标系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%A6%E8%BE%86%E5%9D%90%E6%A0%87%E7%B3%BB"><span class="nav-number">2.2.</span> <span class="nav-text">车辆坐标系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%BD%90%E6%AC%A1%E5%9D%90%E6%A0%87homogeneous-coordinate"><span class="nav-number">2.3.</span> <span class="nav-text">齐次坐标（Homogeneous Coordinate）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%95%E5%BD%B1%E6%96%B9%E7%A8%8B"><span class="nav-number">2.4.</span> <span class="nav-text">投影方程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%95%E5%BA%94%E7%9F%A9%E9%98%B5homography-matrix"><span class="nav-number">3.</span> <span class="nav-text">单应矩阵（Homography Matrix）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E6%AE%8A%E5%BD%A2%E5%BC%8F%E6%8E%A8%E5%AF%BC"><span class="nav-number">3.1.</span> <span class="nav-text">特殊形式推导</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E5%BA%94%E7%9F%A9%E9%98%B5%E4%B8%8E%E7%9B%B8%E6%9C%BA%E5%86%85%E5%A4%96%E5%8F%82%E5%85%B3%E7%B3%BB%E7%9A%84%E4%B8%80%E8%88%AC%E5%BD%A2%E5%BC%8F"><span class="nav-number">3.2.</span> <span class="nav-text">单应矩阵与相机内外参关系的一般形式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E8%A7%86%E6%8A%95%E5%BD%B1bev"><span class="nav-number">4.</span> <span class="nav-text">环视投影&#x2F;BEV</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-number">4.1.</span> <span class="nav-text">基础概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%BE%E7%A4%BA%E8%AF%B4%E6%98%8E"><span class="nav-number">4.2.</span> <span class="nav-text">图示说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%B0%E5%B9%B3%E9%9D%A2%E7%82%B9%E5%88%B0%E7%9B%B8%E6%9C%BA%E6%8A%95%E5%BD%B1"><span class="nav-number">4.3.</span> <span class="nav-text">地平面点到相机投影</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%B0%E5%B9%B3%E9%9D%A2%E7%82%B9%E8%99%9A%E6%8B%9F%E7%9B%B8%E6%9C%BA%E6%8A%95%E5%BD%B1"><span class="nav-number">4.4.</span> <span class="nav-text">地平面点虚拟相机投影</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E4%BC%B0%E8%AE%A1%E7%8E%AF%E8%A7%86%E6%8A%95%E5%BD%B1%E7%9A%84%E5%8D%95%E5%BA%94%E7%9F%A9%E9%98%B5"><span class="nav-number">5.</span> <span class="nav-text">直接估计环视投影的单应矩阵</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%E5%9B%BE"><span class="nav-number">5.1.</span> <span class="nav-text">示例图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E5%BA%94%E7%9F%A9%E9%98%B5%E6%B1%82%E8%A7%A3"><span class="nav-number">5.2.</span> <span class="nav-text">单应矩阵求解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E8%A7%86%E6%8A%95%E5%BD%B1%E5%8D%95%E5%BA%94%E7%9F%A9%E9%98%B5%E6%B1%82%E8%A7%A3"><span class="nav-number">5.3.</span> <span class="nav-text">环视投影单应矩阵求解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%95%E5%BA%94%E7%9F%A9%E9%98%B5%E7%9A%84%E5%85%B6%E4%BB%96%E5%BA%94%E7%94%A8"><span class="nav-number">6.</span> <span class="nav-text">单应矩阵的其他应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">7.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zeal</p>
  <div class="site-description" itemprop="description">学习记录及分享</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zeal-up.github.io/2023/06/08/cv/surround-view-projection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zeal">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zeal's Blog">
      <meta itemprop="description" content="学习记录及分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="超详细！从单应矩阵推导到自动驾驶环视投影应用 | Zeal's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          超详细！从单应矩阵推导到自动驾驶环视投影应用
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-06-08 09:38:44" itemprop="dateCreated datePublished" datetime="2023-06-08T09:38:44+08:00">2023-06-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-06-14 12:07:02" itemprop="dateModified" datetime="2023-06-14T12:07:02+08:00">2023-06-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/" itemprop="url" rel="index"><span itemprop="name">计算机视觉</span></a>
        </span>
    </span>

  
    <span id="/2023/06/08/cv/surround-view-projection/" class="post-meta-item leancloud_visitors" data-flag-title="超详细！从单应矩阵推导到自动驾驶环视投影应用" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="超详细！从单应矩阵推导到自动驾驶环视投影应用" href="/2023/06/08/cv/surround-view-projection/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::f13a6e5ecc3be4fc943645106759d469" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <ul>
<li>⭐ <a href="https://zeal-up.github.io/categories/">Zeal's Blog</a></li>
<li>🛠 <a target="_blank" rel="noopener" href="https://www.zhihu.com/people/kai-shi-dong-liao-ge">Zeal's 知乎专栏</a></li>
<li>🌀 <a target="_blank" rel="noopener" href="https://github.com/zeal-up?tab=repositories">Zeal's Github</a></li>
</ul>
<h2 id="本文内容">本文内容</h2>
<p>本文的主要目的在于介绍自动驾驶中环视投影，也就是所谓的俯瞰图/鸟瞰图/BEV图，其背后的计算机视觉原理。环视投影的背后理论基础就是单应矩阵（Homography Matrix）。为了建立从直观到一般形式，本文从以下章节内容展开</p>
<p>在第一节中先规定相机坐标系和图像坐标系，以及介绍常用的车辆坐标系的规定。同时，对相机投影中常使用的齐次坐标做了简要介绍，顺带回顾相机投影方程。</p>
<p>第二节先对单应矩阵做介绍。对于一个空间中一个平面，以及两个不同姿态的相机，两个相机的对该平面的成像之间的联系是单应矩阵。但是如何从相机间的关系推导单应矩阵的具体形式？该节从特殊化形式和一般化形式两个角度对单应矩阵的表达进行推导。</p>
<p>环视投影是多个方向的地面成像结果到一个位于车辆上方，平行于地面往下成像的虚拟相机的成像结果的变换。第三节详细推导这个应用中的投影过程以及相机内外参与单应矩阵的关系。</p>
<p>第四节介绍如何在不知道相机内外参的情况下通过点对匹配的方法求解单应矩阵。</p>
<h2 id="基础知识及相关定义">基础知识及相关定义</h2>
<h3 id="相机坐标系与图像坐标系">相机坐标系与图像坐标系</h3>
<p>在计算机视觉的一般任务中，我们规定<strong>相机坐标系</strong>为光轴（经过相机原点）往前为<span class="math inline">\(Z\)</span>轴正方向，右为<span class="math inline">\(X\)</span>，下为<span class="math inline">\(Y\)</span> 对空间中的点放缩到归一化平面，归一化平面的坐标系定义也类似相机坐标系。 但是在图像中，我们一般令图片的左上角为坐标原点，横轴往右为<span class="math inline">\(u/X\)</span>正方向，竖轴往下为<span class="math inline">\(v/Y\)</span>正方向，又叫<strong>像素坐标系</strong></p>
<p>如下图所示</p>
<figure>
<img src="./imgs/01-pinhole.png" alt="" /><figcaption>相机及像素坐标系</figcaption>
</figure>
<h3 id="车辆坐标系">车辆坐标系</h3>
<p>我们一般规定车的后轮横轴中心在地面的点为坐标系原点，<span class="math inline">\(X\)</span>正方向指向车头，<span class="math inline">\(Y\)</span>轴正方向指向车左</p>
<figure>
<img src="./imgs/02-vehical_coordinate.png" alt="" /><figcaption>车辆坐标系</figcaption>
</figure>
<h3 id="齐次坐标homogeneous-coordinate">齐次坐标（Homogeneous Coordinate）</h3>
<p>当我们对三维空间中一个点<span class="math inline">\(P_1=[X_1,Y_1,Z_1]^T\)</span>做旋转平移变换到另一个点<span class="math inline">\(P_2\)</span>，可以用下面的公式</p>
<p><span class="math display">\[
P_2 = RP_1+\boldsymbol{t}
\]</span></p>
<p>其中<span class="math inline">\(R\in \mathbb{R}^{3\times3}\)</span>为旋转矩阵，<span class="math inline">\(\boldsymbol{t}\in \mathbb{R}^{3\times 1}\)</span>为平移向量</p>
<p>上式也可以将点坐标写为<span class="math inline">\(P_1=[X_1,Y_1,Z_1,1]^T\)</span>的形式，然后用变换矩阵对点做坐标变换</p>
<p><span class="math display">\[
P_2 = T_{21}P_1
\]</span></p>
<p><span class="math display">\[
T_{21} =
\begin{bmatrix}
R&amp;\boldsymbol{t}\\
\boldsymbol{0}&amp;1
\end{bmatrix}\in \mathbb{R}^{4\times 4}
\]</span></p>
<p><span class="math inline">\(T_{21}\)</span>称为变换矩阵;<span class="math inline">\(P_1=[X_1,Y_1,Z_1,1]^T\)</span>这种形式也叫齐次坐标（Homogeneous Coordinate）</p>
<p><strong>注意</strong>：齐次坐标其实有严格的定义，具体形式可以参考<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/%E9%BD%90%E6%AC%A1%E5%9D%90%E6%A0%87">Wiki:Homogeneous Coordinate</a></p>
<p>同理，在做像素坐标的逆变换，也通常将像素坐标<span class="math inline">\([u,v]^T\)</span>后面添加一个1变为齐次坐标<span class="math inline">\(p=[u,v,1]^T\)</span></p>
<p><span class="math display">\[
p_n=K^{-1}p
\]</span></p>
<h3 id="投影方程">投影方程</h3>
<p>空间中的一个点<span class="math inline">\(P_W\)</span>投影到图像上的点<span class="math inline">\(\boldsymbol{p}\)</span>，我们直接记这个过程为</p>
<p><span class="math display">\[
\begin{split}
\lambda \boldsymbol{p}
&amp;=\
KT_{CW}P_W\\
&amp;=\
\begin{bmatrix}
u&amp;v&amp;1
\end{bmatrix}^T
\end{split}
\]</span></p>
<p>这里面包含了一次齐次坐标的转换（<span class="math inline">\(T_{CW}P_W \in \mathbb{R}^{4\times 1}\)</span>,<span class="math inline">\(K\in \mathbb{R}^{3\times 1}\)</span>），但是不会对理解有歧义</p>
<h2 id="单应矩阵homography-matrix">单应矩阵（Homography Matrix）</h2>
<p>在计算机视觉中，两个相机对于空间中的同一个平面的成像结果可以通过单应矩阵进行映射（相差一个常量系数）</p>
<p>另<span class="math inline">\([x,y,1]^T\)</span>为图片1的像素齐次坐标，<span class="math inline">\([x^{\prime},y^{\prime},1]^T\)</span>为同一个点在图片2的像素齐次坐标，则上面那句话可以等价为如下关系：</p>
<p><span class="math display">\[
\lambda
\begin{bmatrix}
x^{\prime}\\
y^{\prime}\\
1
\end{bmatrix}=
\boldsymbol{H}
\begin{bmatrix}
x\\
y\\
1
\end{bmatrix}=
\begin{bmatrix}
h_{00} &amp; h_{10} &amp; h_{20}\\
h_{01} &amp; h_{11} &amp; h_{21}\\
h_{02} &amp; h_{12} &amp; h_{22}
\end{bmatrix}
\begin{bmatrix}
x\\
y\\
1
\end{bmatrix}\tag{2-1}
\]</span></p>
<p>公式（2-1）中的系数<span class="math inline">\(\lambda\)</span>用来将变换后的坐标归一化（将第三个维度的值放缩为1） <strong>同时要注意，单应矩阵虽然有9个元素，但自由度只有8，可以除以<span class="math inline">\(h_{22}\)</span>进行归一化</strong></p>
<p>下面我们分别从用形象化的解释和一般化的推导来建立单应矩阵与相机内参、外参的关系</p>
<h3 id="特殊形式推导">特殊形式推导</h3>
<p>我们假设空间中有一平面，两个相机<span class="math inline">\(C_1,C_2\)</span>在两个不同的姿态下对这个平面进行成像。同时，我们令世界坐标系（<span class="math inline">\(O_G\)</span>)<span class="math inline">\(的\)</span>Z<span class="math inline">\(轴垂直于该平面，并且令该平面刚好位于世界坐标系的\)</span>XY<span class="math inline">\(平面，这样这个平面上的点\)</span>z$坐标等于0。可以用下图帮忙理解</p>
<figure>
<img src="./imgs/03-multi_camera.png" alt="" /><figcaption>双相机成像统一平面</figcaption>
</figure>
<p>同时，我们记世界坐标系到相机<span class="math inline">\(C_1\)</span>的变换矩阵为<span class="math inline">\(T_{C_1W}\)</span>，到相机<span class="math inline">\(C_2\)</span>的变换矩阵为<span class="math inline">\(T_{C_2W}\)</span>;<span class="math inline">\(K_1,K_2\)</span>为两个相机的内参。</p>
<p>我们现在对平面上的一个点<span class="math inline">\(P_W=[X_w,Y_w,Z_w=0,1]^T\)</span>进行投影，得到在两个相机成像的图片上对应的像素点<span class="math inline">\(\boldsymbol{p}_1,\boldsymbol{p}_2\)</span>。投影过程具有如下形式</p>
<p><span class="math display">\[
\begin{split}
\lambda_1\boldsymbol{p}_1
&amp;=\
\begin{bmatrix}
u_1\\
v_1\\
1
\end{bmatrix}
=\
K_1T_{C_1W}P_W\\
&amp;=\
K_1
\begin{bmatrix}
r_{00} &amp; r_{01} &amp; r_{02} &amp; t_0\\
r_{10} &amp; r_{11} &amp; r_{12} &amp; t_1\\
r_{20} &amp; r_{21} &amp; r_{22} &amp; t_2\\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}
\begin{bmatrix}
X_W\\
Y_W\\
0\\
1
\end{bmatrix}\\
&amp;=\
K_1
\begin{bmatrix}
r_{00} &amp; r_{01} &amp; t_0\\
r_{10} &amp; r_{11} &amp; t_1\\
r_{20} &amp; r_{21} &amp; t_2
\end{bmatrix}
\begin{bmatrix}
X_W\\
Y_W\\
1
\end{bmatrix}\\
&amp;=\
K_1T_{C_1W}^{0:3;0:2,3}P_W
\end{split}
\]</span></p>
<p>上式中<span class="math inline">\(T^{0:3;0:2,3}\)</span>表示变换矩阵前3行的0,1,3列。为了方便记号，我们将<span class="math inline">\(T_{C_1W}^{0:3;0:2,3}\)</span>记为<span class="math inline">\(J_{C_1W}\)</span></p>
<p>同理，我们可以得到图像2的类似投影方程，我们整理如下</p>
<p><span class="math display">\[
\begin{split}
\lambda_1\boldsymbol{p}_1 &amp;= K_1J_{C_1W}P_W\\
\\
\lambda_2\boldsymbol{p}_2 &amp;= K_2J_{C_2W}P_W\\
\end{split}\tag{2-2}
\]</span></p>
<p>注意上式中<span class="math inline">\(P_W=[X_W,Y_W,1]\)</span>，且上式中矩阵相乘的行列数量都是对应的</p>
<p>我们将上式（2-2）重新整理一下，将<span class="math inline">\(P_W\)</span>写为<span class="math inline">\(p_1\)</span>的函数，有</p>
<p><span class="math display">\[
P_W=\lambda_1J_{C_1W}^{-1}K_1^{-1}\boldsymbol{p}_1\tag{2-3}
\]</span></p>
<p>将（2-3）带入（2-2）中的相机2方程</p>
<p><span class="math display">\[
\lambda_2\boldsymbol{p}_2=\lambda_1K_2J_{C_2W}J_{C_1W}^{-1}K_1^{-1}\boldsymbol{p}_1
\]</span></p>
<p>其中<span class="math inline">\(\lambda_1,\lambda_2\)</span>只是为了将投影后的值进行放缩，使得第三个元素的值为1,所以两者可以写成一个，最后我们可以得到如下形式</p>
<p><span class="math display">\[
\begin{split}
&amp;\lambda\boldsymbol{p}_2=\boldsymbol{H}_{21}\boldsymbol{p}_1\\
&amp; \boldsymbol{H}_{21} = K_2J_{C_2W}J_{C_1W}^{-1}K_1^{-1}\\
&amp;J=T^{0:3,0:2,3}
\end{split}\tag{2-4}
\]</span></p>
<p>可以看到，公式（2-4）的形式和公式（2-1）是一样的，同时将单应矩阵与相机的内参外参联系起来</p>
<h3 id="单应矩阵与相机内外参关系的一般形式">单应矩阵与相机内外参关系的一般形式</h3>
<p>上一个小节我们对单应矩阵与相机的内外参之间的关系建立了公式化的联系和直观上的理解。上一小节的推导可以看出，对于空间中的一快平面，存在一个<span class="math inline">\(3 \times 3\)</span>的矩阵（自由度为8）将两个相机对这块平面的成像结果联系起来。</p>
<p>在上一小节中，我们假设世界坐标系与成像平面对齐。我们在这一小节中继续推导更一般的表达形式，这一小节的内容主要参考<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Homography_(computer_vision)">Wiki:Homography (computer vision)</a></p>
<p>由于一般情况下，我们都是知道相机的外参（也就是世界坐标系到相机坐标系的变换关系），所以我们这一节不假设平面的坐标系与世界坐标系对齐，我们假设平面在相机<span class="math inline">\(C_1\)</span>下的法向量为<span class="math inline">\(\boldsymbol{n}\)</span>，平面到相机<span class="math inline">\(C_1\)</span>的距离为<span class="math inline">\(d\)</span>，且对于法向量的方向，我们做如下规定：对于平面上的点<span class="math inline">\(P_{C_1}\)</span>，满足<span class="math inline">\(\boldsymbol{n}^TP_{C_1}+d=0\)</span>，其中<span class="math inline">\(\boldsymbol{n}^TP_{C_1}\)</span>为点到法向量的投影</p>
<figure>
<img src="./imgs/04-homo_general.png" alt="" /><figcaption>单应矩阵的一般形式推导</figcaption>
</figure>
<p>假设相机<span class="math inline">\(C_1\)</span>的外参为<span class="math inline">\(T_{C_1W}=[R_1|\boldsymbol{t}_1]\)</span>，相机<span class="math inline">\(C_2\)</span>的外参为<span class="math inline">\(T_{C_2W}=[R_2|\boldsymbol{t}_2]\)</span>，由变换矩阵的性质，我们可以得到</p>
<p><span class="math display">\[
\begin{split}
T_{WC_1} &amp;= T_{C_1W}^{-1}\\
&amp;= 
\begin{bmatrix}
R_1&amp;\boldsymbol{t}_1\\
\boldsymbol{0}&amp;1
\end{bmatrix}^{-1}\\
&amp;=\
\begin{bmatrix}
R_1^{-1}&amp;-R_1^{-1}\boldsymbol{t}_1\\
\boldsymbol{0}&amp;1
\end{bmatrix}
\end{split}\tag{2-5}
\]</span></p>
<p>所以相机1到相机2的变换矩阵为</p>
<p><span class="math display">\[
\begin{split}
T_{C_2C_1} &amp;= T_{C_2W}T_{WC_1}\\
&amp;= 
\begin{bmatrix}
R_2&amp;\boldsymbol{t}_2\\
\boldsymbol{0}&amp;1
\end{bmatrix}
\begin{bmatrix}
R_1^{-1}&amp;-R_1^{-1}\boldsymbol{t}_1\\
\boldsymbol{0}&amp;1
\end{bmatrix}\\
&amp;=\
\begin{bmatrix}
R_2R_1^{-1}&amp;-R_2R_1^{-1}\boldsymbol{t}_1+\boldsymbol{t}_2\\
\boldsymbol{0}&amp;1
\end{bmatrix}\\
&amp;=\
\begin{bmatrix}
R_{21}&amp;\boldsymbol{t}_{21}\\
\boldsymbol{0}&amp;1
\end{bmatrix}
\end{split}\tag{2-6}
\]</span></p>
<p>根据相机投影关系，我们有</p>
<p><span class="math display">\[
\begin{split}
&amp;\boldsymbol{p}_1=\frac{1}{Z_{C_1}}K_1P_1\\
&amp;\boldsymbol{p}_2=\frac{1}{Z_{C_2}}K_2P_2\\
\end{split}\tag{2-7}
\]</span></p>
<p><span class="math display">\[
P_1 = Z_{C_1}K_1^{-1}\boldsymbol{p}_1\tag{2-8}
\]</span></p>
<p>又<span class="math inline">\(P_1,P_2\)</span>为点<span class="math inline">\(P_W\)</span>在两个相机坐标系下的坐标，这两个点又可以通过下面的变换联系</p>
<p><span class="math display">\[
P_2 = R_{21}P_1 + \boldsymbol{t}_{21}\tag{2-9}
\]</span></p>
<p>联合（2-7）到（2-9），我们可以得出</p>
<p><span class="math display">\[
\boldsymbol{p}_2=\frac{1}{Z_{C_2}}K_2(R_{21}Z_{C_1}K_1^{-1}\boldsymbol{p}_1+\boldsymbol{t}_{21})\tag{2-10}
\]</span></p>
<p>对于平面，我们已经做了如下规定： 在相机<span class="math inline">\(C_1\)</span>坐标系下，对于平面上的点<span class="math inline">\(P_{1}\)</span>，满足<span class="math inline">\(\boldsymbol{n}^TP_{1}+d=0\)</span>，其中<span class="math inline">\(\boldsymbol{n}^TP_{1}\)</span>为点到法向量的投影。即</p>
<p><span class="math display">\[
\frac{\boldsymbol{n}^TP_1}{-d}=1\tag{2-11}
\]</span></p>
<p>将（2-11）带入公式（2-10）中的<span class="math inline">\(\boldsymbol{t}_{21}\)</span>可以得到</p>
<p><span class="math display">\[
\begin{split}
\boldsymbol{t}_{21}
&amp;=\
\boldsymbol{t}_{21}\frac{\boldsymbol{n}^TP_1}{-d}\\
&amp;=\
\frac{\boldsymbol{t}_{21}\boldsymbol{n}^T}{-d}P_1\\
&amp;\overset{2-8}{=}\
-\frac{\boldsymbol{t}_{21}\boldsymbol{n}^T}{d}Z_{C_1}K_1^{-1}\boldsymbol{p}_1
\end{split}\tag{2-12}
\]</span></p>
<p>将（2-12）代入公式（2-10）中，我们可以得到</p>
<p><span class="math display">\[
\begin{split}
\boldsymbol{p}_2&amp;=\frac{1}{Z_{C_2}}K_2\left(R_{21}-\frac{\boldsymbol{t}_{21}\boldsymbol{n}^T}{d}\right)Z_{C_1}K_1^{-1}\boldsymbol{p}_1\\
&amp;=\
\frac{Z_{C_1}}{Z_{C_2}}K_2H_{21}K_1^{-1}\boldsymbol{p_1}
\end{split}\tag{2-13}
\]</span></p>
<p>于是，我们可以得到单应矩阵的表达形式</p>
<p><span class="math display">\[
H_{21} = R_{21}-\frac{\boldsymbol{t}_{21}\boldsymbol{n}^T}{d}\tag{2-14}
\]</span></p>
<p>如果我们将<span class="math inline">\(R_{21}\)</span>与<span class="math inline">\(t_{21}\)</span>的展开形式，即公式（2-6），则我们可以得到</p>
<p><span class="math display">\[
H_{21} = R_2R_1^{-1} - \frac{\left(-R_2R_1^{-1}\boldsymbol{t}_1+\boldsymbol{t}_2\right)\boldsymbol{n}^T}{d}\tag{2-15}
\]</span></p>
<hr />
<p>这篇论文<a target="_blank" rel="noopener" href="https://sci-hub.st/10.1145/3343031.3350885">Online Camera Pose Optimization for the Surround-viewSystem</a>，中关于环视图的地平面投影一章的公式推导很详细，作为基础理论学习很不错。</p>
<h2 id="环视投影bev">环视投影/BEV</h2>
<h3 id="基础概念">基础概念</h3>
<p>从前文中我们可以得出，对于空间中的一个平面，不同位姿的相机成像的图片可以通过单应矩阵在不同的图片中进行变换。对于自动驾驶车辆来说，环绕车周的多个摄像头(一般是4个及以上)会同时拍摄到地面。同时，我们可以假设有一个虚拟相机位于车辆正上方往下拍摄。这样，车周的摄像头可以根据地平面对应的单应矩阵投影到虚拟相机，得到所谓的俯瞰图/鸟瞰图，也就是 <strong>BEV(Bird Eye View)</strong></p>
<h3 id="图示说明">图示说明</h3>
<hr />
<figure>
<img src="./imgs/05-ground_coor.png" alt="" /><figcaption>地面坐标系与环视图片坐标系的联系</figcaption>
</figure>
<p>上图中<span class="math inline">\(O_G\)</span>是地面坐标系，这里与第一节中说明的车辆坐标系有一点不同，主要是为了方便后文进行公式推导。实际中只需要把图中的地面坐标系与车辆坐标系根据车身参数简单计算出变换矩阵即可。</p>
<p>上图中<span class="math inline">\(O_I\)</span>是图像坐标系，以左上角为坐标原点，<span class="math inline">\(u,v\)</span>为像素的横轴、纵轴坐标值。<span class="math inline">\(H,W\)</span>为我们希望得到的地平面投影图像的投影范围，单位是<span class="math inline">\(米\)</span>。同时，我们令<span class="math inline">\(d_W,d_H\)</span>为图像每个像素对应的实际中方格的大小，单位也是<span class="math inline">\(米\)</span></p>
<hr />
<h3 id="地平面点到相机投影">地平面点到相机投影</h3>
<p>假设车周有4个相机<span class="math inline">\(C_1,C_2,C_3,C_4\)</span>，4个相机的与地面坐标系的位姿关系为<span class="math inline">\(T_{C_1G}, T_{C_2G}, T_{C_3G}, T_{C_4G}\)</span></p>
<p>对于一个地面坐标系下的点<span class="math inline">\(P_{G}=[X_G,Y_G,Z_G,1]^T\)</span>，在通过投影方程投影在相机<span class="math inline">\(C_i\)</span>上的图像像素坐标<span class="math inline">\(\boldsymbol{p}_i\)</span>有如下关系：</p>
<p><span class="math display">\[
\begin{split}
P_{C_i}&amp;=T_{C_iG}P_G\\
&amp;=
\begin{bmatrix}
X_{C_i} &amp; Y_{C_i} &amp; Z_{C_i} &amp; 1
\end{bmatrix}^T
\end{split}
\]</span></p>
<p>则<span class="math inline">\(P_G\)</span>在相机<span class="math inline">\(C_i\)</span>中对应的像素坐标为</p>
<p><span class="math display">\[
\begin{split}
\lambda_{C_i} \boldsymbol{p}_{C_i} 
&amp;=\
K_{C_i}P_{C_{i}}\\
&amp;=\
K_{C_i}T_{C_iG}P_G
\end{split}\tag{3-1}
\]</span></p>
<p><span class="math inline">\(K_{C_i}\)</span>是相机<span class="math inline">\(C_i\)</span>的内参，<span class="math inline">\(\lambda_{C_i}\)</span>是放缩系数，确保最后<span class="math inline">\(\boldsymbol{p}_{C_i}\)</span>的第三个维度值为1,也就是具有如下形式：<span class="math inline">\(\boldsymbol{p}_{C_i}=[u,v,1]^T\)</span>。另外，要注意（3-1）中包含一个齐次坐标的变换。</p>
<p>现在假设点<span class="math inline">\(P_G\)</span>的<span class="math inline">\(Z\)</span>轴坐标是0,也就是点位于地面，则 <span class="math inline">\(P_{G}=[X_G,Y_G,0,1]^T\)</span>，上面<span class="math inline">\(P_{C_i}=T_{C_iG}P_G\)</span>展开会变成</p>
<p><span class="math display">\[
\begin{split}
P_{C_i}&amp;=T_{C_iG}P_G\\
&amp;=
\begin{bmatrix}
r_{00} &amp; r_{01} &amp; r_{02} &amp; t_0\\
r_{10} &amp; r_{11} &amp; r_{12} &amp; t_1\\
r_{20} &amp; r_{21} &amp; r_{22} &amp; t_2\\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}
\begin{bmatrix}
X_{G_i}\\
Y_{G_i}\\
0\\
1
\end{bmatrix}\\
&amp;=
\begin{bmatrix}
r_{00} &amp; r_{01} &amp; t_0\\
r_{10} &amp; r_{11} &amp; t_1\\
r_{20} &amp; r_{21} &amp; t_2\\
0 &amp; 0 &amp; 1
\end{bmatrix}
\begin{bmatrix}
X_{G_i}\\
Y_{G_i}\\
1
\end{bmatrix}
\end{split}
\]</span></p>
<p>我们可以重新记公式（3-1）为</p>
<p><span class="math display">\[
\begin{split}
\lambda_{C_i}\boldsymbol{p}_{C_i}=K_{C_i}T_{C_iG}^{0:3;0:2,3}P_G
\end{split}\tag{3-3}
\]</span></p>
<p>其中</p>
<p><span class="math display">\[
T_{C_iG}^{0:3;0:2,3} =
\begin{bmatrix}
r_{00} &amp; r_{01} &amp; t_0\\
r_{10} &amp; r_{11} &amp; t_1\\
r_{20} &amp; r_{21} &amp; t_2
\end{bmatrix}
\]</span></p>
<p>表示变换矩阵的前三行，第0,1,3列</p>
<p>公式（3-3）实际就是第二节中推导出的公式（2-2）</p>
<h3 id="地平面点虚拟相机投影">地平面点虚拟相机投影</h3>
<p>根据上图，假设我们想要投影以地面坐标系原点为中心，<span class="math inline">\(H\times W\)</span>的地面区域。同时，我们希望投影后的像素分辨率为一个像素对应横轴、长轴为<span class="math inline">\(d_W,d_H\)</span>长度的地面方格。<strong>（PS:实际上相机的焦距的定义就是每个像素对应的实际尺寸，焦距的单位为<span class="math inline">\(pixel/meter\)</span>）</strong>。对于地平面投影，我们可以假设有一个虚拟相机位于地面上1米，这样<span class="math inline">\(u=f_xX_G+c_x\)</span>，<span class="math inline">\(f_x=\frac{1}{d_W}\)</span>，<span class="math inline">\(c_x=\frac{W}{2d_W}\)</span>。我们可以写成如下的形式</p>
<p><span class="math display">\[
\begin{bmatrix}
u_G\\
v_G\\
1
\end{bmatrix}=
\begin{bmatrix}
\frac{1}{d_W} &amp; 0 &amp; \frac{W}{2d_W}\\
0 &amp; \frac{1}{d_H} &amp; \frac{H}{2d_H}\\
0 &amp; 0 &amp; 1
\end{bmatrix}
\begin{bmatrix}
X_G\\
Y_G\\
1
\end{bmatrix}\tag{3-4}
\]</span></p>
<p>上式可以写成矩阵形式，我们记<span class="math inline">\(K_G\)</span>为上式中的矩阵（虚拟相机的内参）</p>
<p><span class="math display">\[
\boldsymbol{p}_G = K_GP_G\tag{3-5}
\]</span></p>
<p>联立公式（3-3）和公式（3-5）可以写为如下形式</p>
<p><span class="math display">\[
\lambda \boldsymbol{p}_G=K_G\left(T_{C_iG}^{0:3;0:2,3}\right)^{-1}K_{C_i}^{-1}\boldsymbol{p}_{C_i}\tag{3-6}
\]</span></p>
<p>其中，<span class="math inline">\(\lambda\)</span>系数只是为了将<span class="math inline">\(\boldsymbol{p}_G\)</span>的最后一个维度归一化，不需要具体形式。</p>
<h2 id="直接估计环视投影的单应矩阵">直接估计环视投影的单应矩阵</h2>
<p>除了根据第三节的推导，从相机内外参直接推导出车周相机到地平面的投影矩阵，还可以直接人工选点估计单应矩阵。这一点跟透视矫正（Perspective Correction）任务基本类似。所谓的透视矫正，就是对于同一个平面的不同成像结果（两张图片），我们选择两张图片上的对应点构建对应点集，根据单应矩阵的定义</p>
<p><span class="math display">\[
\boldsymbol{p}_2 = H_{21}\boldsymbol{p}_1
\]</span></p>
<p>我们可以从对应的点集中求解出单应矩阵。由于前面第二节我们知道单应矩阵的实际自由度为8，而一个对应点对可以构建两个约束方程（<span class="math inline">\(x,y\)</span>），所以我们一共最少需要4个点对来求解单应矩阵。</p>
<h3 id="示例图">示例图</h3>
<p>还是以上文的简笔图来说明</p>
<figure>
<img src="./imgs/06-perspective_correction.png" alt="" /><figcaption>透视矫正示意图</figcaption>
</figure>
<p>上图中两个相机对同一个平面成像，得到两张图片。两张图片中<span class="math inline">\(A,B,C,D\)</span>四个点是一一对应的关系，记这些点对为<span class="math inline">\(\boldsymbol{p}_i,\boldsymbol{p}_i^{\prime}\)</span>，则我们可以建立方程</p>
<p><span class="math display">\[
\begin{split}
\lambda \boldsymbol{p}_i^{\prime}&amp;=H\boldsymbol{p}_i
\end{split}
\]</span></p>
<p>即 <span class="math display">\[
\lambda
\begin{bmatrix}
u_i^{\prime}\\
v_i^{\prime}\\
1
\end{bmatrix}
=\
\begin{bmatrix}
h_{00}&amp;h_{01}&amp;h_{02}\\
h_{10}&amp;h_{11}&amp;h_{21}\\
h_{20}&amp;h_{21}&amp;h_{22}\\
\end{bmatrix}
\begin{bmatrix}
u_i\\
v_i\\
1
\end{bmatrix}\tag{4-1}
\]</span></p>
<h3 id="单应矩阵求解">单应矩阵求解</h3>
<p>公式（4-1）的求解可以用最小二乘法，或者最小二乘法+RANSAC等算法，优化目标为：</p>
<p><span class="math display">\[
J = \sum_{i}\left(u_i^{\prime}-\frac{h_{00}u_i+h_{01}v_i+h_{02}}{h_{20}u_i+h_{21}v_i+h_{22}}\right)^2+\left(v_i^{\prime}-\frac{h_{10}u_i+h_{11}v_i+h_{21}}{h_{20}u_i+h_{21}v_i+h_{22}}\right)^2
\]</span></p>
<p>这部分的求解可以使用OpenCV的函数<a target="_blank" rel="noopener" href="https://docs.opencv.org/4.7.0/d9/d0c/group__calib3d.html#ga4abc2ece9fab9398f2e560d53c8c9780">OpenCV:findHomography</a></p>
<h3 id="环视投影单应矩阵求解">环视投影单应矩阵求解</h3>
<p>在环视投影中，我们需要一些额外的标定物要求解单应矩阵。主要的原理就是我们将地面上的坐标和图像中的坐标联立写成如公式（4-1）的形式，然后调用接口计算单应矩阵。图像中的坐标可以通过手工选点，也可以通过一些角点检测程序。</p>
<figure>
<img src="./imgs/07-compute-homo.png" alt="" /><figcaption>环视单应矩阵求解</figcaption>
</figure>
<p>上图引用自：https://www.guyuehome.com/39649</p>
<p>上图中0,1,2,3四个点是在图片上选择的点，因此知道像素值。同时，我们又可以通过标定布的几何属性以及我们提前设定的投影图的分辨率，得出这四个点在BEV上的等效像素值，于是我们就可以求解方程（4-1）得出单应矩阵</p>
<h2 id="单应矩阵的其他应用">单应矩阵的其他应用</h2>
<p>单应矩阵还可以用在求解平面标定板的位姿、全景图拼接等应用，<a target="_blank" rel="noopener" href="https://docs.opencv.org/4.x/d9/dab/tutorial_homography.html">OpenCV的这一篇教程</a>写得十分详细，这里就不再赘述。</p>
<h2 id="参考资料">参考资料</h2>
<ol type="1">
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Homography_(computer_vision)">Wiki:Homography_(computer_vision)</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.opencv.org/4.7.0/d9/d0c/group__calib3d.html#ga4abc2ece9fab9398f2e560d53c8c9780">OpenCV:findHomography</a></li>
<li><a target="_blank" rel="noopener" href="https://www.guyuehome.com/39649">古月居:AVM 环视拼接方法介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.opencv.org/4.x/d9/dab/tutorial_homography.html">OpenCV：Basic concepts of the homography explained with code</a></li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Zeal
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://zeal-up.github.io/2023/06/08/cv/surround-view-projection/" title="超详细！从单应矩阵推导到自动驾驶环视投影应用">https://zeal-up.github.io/2023/06/08/cv/surround-view-projection/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/camera-projection/" rel="tag"># camera projection</a>
              <a href="/tags/%E8%A7%86%E8%A7%89%E5%9F%BA%E7%A1%80/" rel="tag"># 视觉基础</a>
              <a href="/tags/%E7%8E%AF%E8%A7%86%E6%8A%95%E5%BD%B1/" rel="tag"># 环视投影</a>
              <a href="/tags/%E5%8D%95%E5%BA%94%E7%9F%A9%E9%98%B5/" rel="tag"># 单应矩阵</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/06/05/cv/camera-model/" rel="prev" title="吐血整理：从相机模型（针孔、鱼眼、全景）到OpenCV源码实现">
                  <i class="fa fa-chevron-left"></i> 吐血整理：从相机模型（针孔、鱼眼、全景）到OpenCV源码实现
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/06/12/slam-theory/manifold-integration/" rel="next" title="从IMU预积分理解最大后验概率问题及李代数应用">
                  从IMU预积分理解最大后验概率问题及李代数应用 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="SOHUCS" sid="f13a6e5ecc3be4fc943645106759d469"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zeal</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"covS4Q3Q0SaMRjqI2VomagVm-gzGzoHsz","app_key":"iK7kdlu4InjORoPr3oksi1IM","server_url":"https://covs4q3q.lc-cn-n1-shared.com","security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="changyan" type="application/json">{"enable":true,"appid":"cywzGuJ0w","appkey":"7c4a236bb42c7db38424a76bf68ccf99","count":true}</script>
<script src="/js/third-party/comments/changyan.js"></script>

</body>
</html>
